#!/usr/bin/env python3

import subprocess
import yaml
import os
import sys

import openstack


def get_data_port_config(juju_version, service):
    data_ports = ''
    if juju_version == 1:
        config = yaml.load(
            subprocess.check_output(['juju', 'get', service])
        )
        data_port_settings = config['settings']['data-port']
        if 'value' in data_port_settings:
            data_ports = data_port_settings['value']
    else:
        data_ports = subprocess.check_output(
            ['juju', 'config', service, 'data-port']).decode('UTF-8')

    return data_ports.split(' ')


if __name__ == '__main__':
    conn = openstack.connect(load_envvars=True)

    net_id: str | None = os.environ.get('NET_ID')
    net_name: str | None = None
    if net_id:
        # Use OSCI / Jenkins environment variable if defined.
        print('Using NET_ID environment variable: {}'.format(net_id))
        network = conn.get_network(net_id)
        if network is None:
            print('Unable to find network with id: {}'.format(net_id))
            raise ValueError('Unable to find network {}'.format(net_id))
        net_name = network['name']
    else:
        # Preserve existing default behavior (eg. manual testing)
        net_name = os.environ.get('UNDERCLOUD_EXT_NET')
        if not net_name:
            net_name = os.environ['OS_USERNAME'] + '_admin_net'

        print('Using default network name: {}'.format(net_name))
        network = conn.get_network(net_name)
        if network is None:
            print('Unable to find local network {}'.format(net_name))
            raise ValueError('Unable to find local network {}'.format(net_name))
        net_id = network['id']

    ext_aliases = conn.get_network_extensions()

    service = sys.argv[1]

    juju_version = int(subprocess.check_output(
        ['juju', 'version']).decode('UTF-8').strip()[0])

    service_config = yaml.safe_load(
        subprocess.check_output(['juju', 'status', '--format=yaml',
                                 service]).decode('UTF-8')
    )

    uuids = []
    for machine in service_config['machines']:
        uuids.append(service_config['machines'][machine]['instance-id'])

    unit_addresses = []
    applications = 'applications'
    if 'services' in service_config:
        applications = 'services'

    units = service_config[applications][service].get('units', None)
    if not units:
        print("Application '{}' has no units to configure".format(service))
        sys.exit(0)

    for unit in units.values():
        if unit['public-address']:
            unit_addresses.append(unit['public-address'])

    ext_port = []
    if len(sys.argv) >= 3:
        ext_port = [sys.argv[2]]
    config_ports = get_data_port_config(juju_version, service)

    for uuid in uuids:
        print('Configuring interface for instance {}'.format(uuid))
        server = conn.get_server(uuid)

        # Check how many interfaces have been attached to the instance
        # already to see if more are necessary.
        attached_ports = conn.search_ports(
            name_or_id=net_id, filters={'device_id': uuid}
        )

        data_port = None
        for port in attached_ports:
            # Don't consider the port containing the unit address
            if port['fixed_ips'][0]['ip_address'] in unit_addresses:
                continue

            # Pick the first mac address which is not the unit address
            data_port = port['mac_address']
            break

        if data_port is None:
            # Attach a new port
            print("Attaching interface to instance {}".format(uuid))
            new_port = {
                "port": {
                    "admin_state_up": True,
                    "name": "data-port",
                    "network_id": net_id,
                }
            }

            extra_options = {}
            if 'port-security' in ext_aliases:
                extra_options['port_security_enabled'] = False

            result = conn.create_port(
                net_id,
                name='data-port',
                admin_state_up=True,
                **extra_options,
            )
            result = conn.compute.create_server_interface(
                server=server.id, port_id=result.id
            )
            data_port = result['mac_addr']
        else:
            print("Using existing interface {} "
                  "for instance {}".format(data_port, uuid))

        data_port = "br-data:{}".format(data_port)
        if data_port not in ext_port:
            ext_port.append(data_port)

    ports = " ".join(ext_port)
    print("Setting data-port configuration on {} to {}".format(service, ports))
    subprocess.check_call(['juju', 'config', service,
                          'data-port={}'.format(ports)])