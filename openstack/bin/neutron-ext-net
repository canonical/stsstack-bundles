#!/usr/bin/env python3

import optparse
import sys
import logging

import openstack

usage = """Usage: %prog [options] ext_net_name

For example:

  %prog -g 192.168.21.1 -c 192.168.21.0/25 \\
      -f 192.168.21.100:192.168.21.200 ext_net
"""

if __name__ == '__main__':
    parser = optparse.OptionParser(usage)
    parser.add_option('-p', '--project',
                      help='Project name to create network for',
                      dest='project', action='store',
                      default=None)
    parser.add_option("-d", "--debug",
                      help="Enable debug logging",
                      dest="debug", action="store_true", default=False)
    parser.add_option("-g", "--gateway",
                      help="Default gateway to use.",
                      dest="default_gateway", action="store", default=None)
    parser.add_option("-c", "--cidr",
                      help="CIDR of external network.",
                      dest="cidr", action="store", default=None)
    parser.add_option("-f", "--floating-range",
                      help="Range of floating IP's to use (separated by :).",
                      dest="floating_range", action="store", default=None)
    parser.add_option("--network-type",
                      help="Network type.",
                      dest="network_type", action="store", default='gre')
    parser.add_option("--vlan-id",
                      help="Vlan_id",
                      dest="vlan_id", action="store", default='2')
    parser.add_option("--physical-network",
                      help="Physical network.",
                      dest="physical_network", action="store", default='physnet1')
    (opts, args) = parser.parse_args()

    if len(args) != 1:
        parser.print_help()
        sys.exit(1)

    if opts.debug:
        logging.basicConfig(level=logging.DEBUG)
    else:
        logging.basicConfig(level=logging.INFO)

    net_name = args[0]
    subnet_name = '{}_subnet'.format(net_name)

    if (opts.floating_range):
        (start_floating_ip, end_floating_ip) = opts.floating_range.split(':')
    else:
        start_floating_ip = None
        end_floating_ip = None

    conn = openstack.connect(envvars=True)

    # Resolve project id
    project_id = conn.current_project_id
    if not project_id:
        logging.error("Unable to locate project id for %s.", opts.project)
        sys.exit(1)

    networks = conn.list_networks(filters={'name':net_name})
    if len(networks) == 0:
        logging.info("Configuring external network '%s'", net_name)
        network_args = {
            'name': net_name,
            'external': True,
            # NOTE: project_id doesn't show up in the explicit
            # kwargs as of 8.2.0, but is supported anyway
            # as it is properly passed along through **kwargs
            'project_id': project_id,
            'provider': {'network_type': opts.network_type},
        }

        if opts.network_type == 'vxlan':
            network_args['provider']['segmentation_id'] = 1234
        elif opts.network_type == 'vlan':
            network_args['provider']['segmentation_id'] = opts.vlan_id
            network_args['provider']['physical_network'] = opts.physical_network
        elif opts.network_type == 'flat':
            network_args['provider']['physical_network'] = opts.physical_network
        else:
            network_args['provider']['segmentation_id'] = 2

        logging.info('Creating new external network definition: %s', net_name)
        network = conn.create_network(**network_args)
        logging.info('New external network created: %s', network.id)
    else:
        logging.warning('Network %s already exists.', net_name)
        network = networks[0]

    subnets = conn.list_subnets(filters={'name': subnet_name})
    if len(subnets) == 0:
        subnet_args= {
            'name': subnet_name,
            'enable_dhcp': False,
            'ip_version': 4,
            'project_id': project_id
        }

        if opts.default_gateway:
            subnet_args['gateway_ip'] = opts.default_gateway
        if opts.cidr:
            subnet_args['cidr'] = opts.cidr
        if (start_floating_ip and end_floating_ip):
            subnet_args['allocation_pools'] = [{
                'start': start_floating_ip,
                'end': end_floating_ip
            }]

        logging.info('Creating new subnet for %s', net_name)
        subnet = conn.create_subnet(network.id, **subnet_args)
        logging.info('New subnet created: %s', subnet.id)
    else:
        logging.warning('Subnet %s already exists.', subnet_name)
        subnet = subnets[0]

    routers = conn.list_routers(filters={'name':'provider-router'})
    if len(routers) == 0:
        logging.info('Creating provider router for external network access')
        router = conn.create_router(
            name='provider-router',
            project_id=project_id,
        )
        logging.info('New router created: %s', (router['id']))
    else:
        logging.warning('Router provider-router already exists.')
        router = routers[0]

    ports = conn.list_ports(filters={
        'device_owner': 'network:router_gateway',
        'network_id': network['id']})
    if len(ports) == 0:
        logging.info('Plugging router into ext_net')
        conn.update_router(
            router['id'],
            ext_gateway_net_id=network['id']
        )
        logging.info('Router connected to %s', net_name)
    else:
        logging.warning('Router already connect to %s', net_name)
